+ `Consistency（一致性）`:由于分布式环境存在多个节点，这些节点上的数据在同一时间所存储的数据必须是一致的，这就是一致性协议。
+ `Availability（可用性）`:可用性很好理解，任何时刻需要保证服务的可用和稳定。
+ `Partition Tolerance（分区容错）`:所谓分区容错是指某个时刻出现网络或者硬件不可用，甚至宕机，其它的机器还能保证正常可用

# 1. Zookeeper 和Eureka的区别

+ **Eureka基于AP， 注重服务的可用性，即使所有机器都挂了，也能拿到本地缓存的数据，保证高可用。**
+ **Zookeeper基于CP， 注重数据的一致性，若主机挂掉则zk集群整体不对外提供服务了，需要选一个新leader的出来（120s作用）才能继续对外提供服务，不保证高可用**



# 2.网关动态路由
> + 看动态路由课程
> + 鉴权
> + 黑白名单
> + 限流
>   + 单个服务限流：aop，过滤器
>   + 整体限流：过滤器
> + jwt 相关面试

# 3.注册中心挂了，服务还可以调用吗

可以也不可以。

+ 可以：因为消费者服务会从注册中心拉取服务，存在缓存中，如果这个时候没有定时去拉取消费者列表，直接取缓存的ip列表，所以是可以调用的
+ 不可以，消费者在本地的缓存失效了，那么就是调不通的
+ eureka使用http协议进行通讯

# 4.Spring cloud config

便于服务的管理

# 5.雪崩效应(熔断器的背景)

在[微服务](https://so.csdn.net/so/search?q=微服务&spm=1001.2101.3001.7020)架构中，一个应用由多个服务组成。相互依赖，依赖关系错综复杂。若有一个服务因为故障原因，可能会导致整个服务崩溃。

![image-20220714001745670](https://cdn.wuzx.cool/image-20220714001745670.png)

**微服务系统因为一个服务出现故障，而导致故障沿着服务调用而疯狂蔓延，进而导致整个微服务系统瘫痪，这就是"雪崩效应"**

**Spring Cloud Hystrix具有服务降级，服务熔断，线程隔离，请求缓存，请求合并以及实时故障监控等强大功能**

## Hystrix实现熔断机制

在SpringCLoud中，熔断机制是通过Hystrix实现的。Hystrix会监控微服务间调用的情况，当失败调用达到一定比例时(例如5秒内失败20次)，就会启动熔断机制。

+ 当服务的调用出错率达到后超过Hystirx规定的出错比率(默认为50%)，熔断器进入熔断开启状态。
+ 熔断器进入熔断开启状态后，Hystrix会启动一个休眠时间窗，在这个时间窗内，该服务的降级逻辑会临时充当业务主逻辑，而原来的业务主逻辑不可用。
+ 当有请求再次调用该服务时，会直接调用降级逻辑快递返回失败效应，以避免系统雪崩。
+ 当休眠时间窗到期后，Hystrix会进入半熔断状态，允许部分请求对由原来的业务主逻辑进行调用，并监控其成功率。
+ 如果调用成功率达到预期，说明服务恢复正常，Hystrix进入熔断关闭状态，服务原来的业务逻辑恢复。否则Hystrix将进入熔断开启状态，休眠时间窗口重新计时。

# 6.Eureka原理

![image-20220310013209224](https://cdn.wuzx.cool/image-20220310013209224.png)

Eureka包括两个组件：eureka server和 eureka client，eureka通过心跳检测，客户端缓存，提高系统的灵活性，可伸缩性，可维护性、可用性

+ 服务提供者向`eureka server`注册服务信息，`eureka server`接受到注册事件，在集群中进行数据同步，
+ 每个Eureka Server同时也是Eureka Client，多个Eureka Server之间通过复 制的方式完成服务注册列表的同步
+ 服务消费者也是一个client从`eureka server`pull服务注册信息，保存在本地
+ 服务启动之后，服务提供者会定时的向Eureka发送心跳（默认是30s）renew续约自己的信息
+ 如果`eureka server`在一定的事件内没有收到某个服务的心跳，`eureka server`将会注销这个服务（默认是90秒）

## 什么是eureka的自我保护

> 定期的续约(服务提供者和注册中心通信),假如服务提供者和注册中心之间因为网络问题，但是不代表服务不可用，不代表服务消费者无法访问服务提供者，如果15分钟之类，85%的客户端都没有进行心跳，那么eureka server会认为客户端与注册中间出现了网络问题，eureka server进入自我保护模式

## 为什么要自我保护

> 默认情况下，如果服务提供者和eureka server 在90没有接受到客户端的心跳，那么eureka将会注销该实例，但是由于网络发生问题，客户端和eureka server 无法进行通信，微服务本身是可以正常运行的，所以不应该移除这个服务，应该进行保护起来

## 自我保护模式

+ 不会提出任何服务实例，(可能是服务提供者和EurekaServer之间网络问题)，保 证了大多数服务依然可用
+ Eureka server仍然可以接受新服务的注册，但是不会同步复制给其他的节点。保证当前节点依然可以用。当网络稳定的时候，新的注册信息将会同步复制到其他的节点

# 7.Ribbon 

## 1.LoadBalancerAutoConfiguration

> 1. 声明` List<RestTemplate> restTemplates`然后注入所有的标注@Loadbalanced的restTemplate
> 2. 创建`restTemplateCustomizer`作用就是会为每一个restTemplate对象设置拦截器
> 3. 使用`restTemplateCustomizer`给每个resetTemplate设置拦截器

## 2. 调用restTemplate.getxxx()

> + `LoadBalancerInterceptor.intercept()`进入

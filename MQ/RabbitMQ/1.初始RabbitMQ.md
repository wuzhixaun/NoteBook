# 1.**什么是MQ?为什么要用MQ**

MQ:MessageQueue，消息队列。 队列，是一种FIFO 先进先出的数据结构。消 息由生产者发送到MQ进行排队，然后按原来的顺序交由消息的消费者进行处理。 QQ和微信就是典型的MQ

MQ的作用主要有以下三个方面:

+ 异步

  作用:异步能提高系统的响应速度、吞吐量。

+ 解耦

  作用:

  1、服务之间进行解耦，才可以减少服务之间的影响。提高系统整体的稳定性以 及可扩展性。

  2、另外，解耦后可以实现数据分发。生产者发送一个消息后，可以由一个或者 多个消费者进行消费，并且消费者的增加或者减少对生产者没有影响

+ 削峰

  例子:长江每年都会涨水，但是下游出水口的速度是基本稳定的，所以会涨水。
   引入三峡大坝后，可以把水储存起来，下游慢慢排水。
   作用:以稳定的系统资源应对突发的流量冲击。

# 2.**MQ的优缺点**

+ 系统可用性降低

  系统引入的外部依赖增多，系统的稳定性就会变差。一旦MQ宕机，对业务会产生影 响。这就需要考虑如何保证MQ的高可用。

+ 系统复杂度提高
  引入MQ后系统的复杂度会大大提高。以前服务之间可以进行同步的服务调用，引入 MQ后，会变为异步调用，数据的链路就会变得更复杂。并且还会带来其他一些问 题。**比如:如何保证消费不会丢失?不会被重复调用?怎么保证消息的顺序性等问 题。**

+ 消息一致性问题

  A系统处理完业务，通过MQ发送消息给B、C系统进行后续的业务处理。如果B系统 处理成功，C系统处理失败怎么办?这就需要考虑如何保证消息数据处理的一致性。



# 3.	**几大MQ产品特点比较**

![image-20220716233601339](https://cdn.wuzx.cool/image-20220716233601339.png)

# 4. **RabbitMQ集群**

## **默认的普通集群模式**:

> 这种集群模式下，集群的各 个节点之间只会有相同的元数据，即队列结构，而消息不会进行冗余，只存在一 个节点中。消费时，如果消费的不是存有数据的节点， RabbitMQ会临时在节点 之间进行数据传输，将消息从存有数据的节点传输到消费的节点
>
> 这种集群模式也不支持高可用，即当某一个节点服务挂了后，需要手动重
>  启服务，才能保证这一部分消息能正常消费

## **镜像模式**:

> 镜像节点中间主动进行消息同步，而不是在客户端拉取消息时临时同 步。
>
> 且在集群内部有一个算法会选举产生master和slave，当一个master挂了后， 也会自动选出一个来。从而给整个集群提供高可用能力。
>
>  这种模式的消息可靠性更高，因为每个节点上都存着全量的消息。而他的弊端也
>  是明显的，集群内部的网络带宽会被这种同步通讯大量的消耗，进而降低整个集
>  群的性能。这种模式下，队列数量最好不要过多

![image-20220717002736010](https://cdn.wuzx.cool/image-20220717002736010.png)

+ Disc: 代表exchanges、channels、queue保存在硬盘中
+ Ram: 代表exchanges、channels、queue保存在内存中
+ 区别
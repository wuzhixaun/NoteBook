[TOC]

# 使用二进制方式搭建k8s集群

## 1、操作系统初始化(和之前一样)

## 2、为etcd和apiserver`自签证书`

### 2.1 准备cfssl证书生成工具

cfssl是一个开源的证书管理工具，使用`json`文件生成证书，相比openssl更方便使用

**下载**

```
wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64
wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64
wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64
chmod +x cfssl_linux-amd64 cfssljson_linux-amd64 cfssl-certinfo_linux-amd64
mv cfssl_linux-amd64 /usr/local/bin/cfssl
mv cfssljson_linux-amd64 /usr/local/bin/cfssljson
mv cfssl-certinfo_linux-amd64 /usr/local/bin/cfssl-certinfo
```

### 2.2 创建CA(Certificate Authority)

```
cfssl print-defaults config > config.json # 默认配置模板
cfssl print-defaults csr > csr.json #默认csr请求模板

```

```
# 知识点：
1.ca-config.json：可以定义多个 profiles，分别指定不同的过期时间、使用场景等参数；后续在签名证书时使用某个   profile；此实例只有一个kubernetes模板。
2.signing：表示该证书可用于签名其它证书；生成的 ca.pem 证书中 CA=TRUE；
3.server auth：表示client可以用该 CA 对server提供的证书进行验证；
4.client auth：表示server可以用该CA对client提供的证书进行验证；注意标点符号，最后一个字段一般是没有都好的。
  cat > ca-config.json <<EOF
  {
    "signing": {
      "default": {
        "expiry": "87600h"
      },
      "profiles": {
        "kubernetes": {
          "usages": [
            "signing",
            "key encipherment",
            "server auth",
            "client auth"
          ],
          "expiry": "87600h"
        }
      }
    }
  }
  EOF
```

### 2.3创建证书请求

+ 知识点：

```
"CN"：Common Name，kube-apiserver 从证书中提取该字段作为请求的用户名 (User Name)
"O"：Organization，kube-apiserver 从证书中提取该字段作为请求用户所属的组 (Group)
```

```
cat > ca-csr.json <<EOF
{
	"CN": "kubernetes",
	"key": {
		"algo": "rsa",
		"size": 2048
	},
	"names": [{
		"C": "CN",
		"ST": "GuangDong",
		"L": "ShenZhen",
		"O": "k8s",
		"OU": "System"
	}],
	"ca": {
		"expiry": "87600h"
	}
}
EOF
```

## 2.4 生成CA证书和私钥

```
generate_etcd_cert.sh 
cfssl gencert -initca ca-csr.json | cfssljson -bare ca -
cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=www server-csr.json | cfssljson -bare server
```

```
cfssl gencert -initca ca-csr.json | cfssljson -bare ca 
将会生成 ca-key.pem（私钥）  ca.pem（公钥）
知识点： cfssljson只是整理json格式，-bare主要的意义在于命名 （个人见解，以便理解，勿喷）
```

## 3、部署etcd存储集群

### 3.1从github下载二进制文件

+ 下载地址：https://github.com/etcd-io/etcd/releases/download/v3.4.9/etcd-v3.4.9-linux-amd64.tar.gz

+ 生成etcd.server文件

  ```
  [Unit]
  Description=Etcd Server
  After=network.target
  After=network-online.target
  Wants=network-online.target
  
  [Service]
  Type=notify
  WorkingDirectory=/var/lib/etcd/
  EnvironmentFile=-/opt/etcd/etcd.conf
  User=etcd
  
  # set GOMAXPROCS to number of processors
  ExecStart=/opt/etcd/bin/etcd --name=${ETCD_NAME} --data-dir=${ETCD_DATA_DIR} --listen-client-urls=${ETCD_LISTEN_CLIENT_URLS},http://172.18.116.233:2379 --listen-peer-urls=${ETCD_LISTEN_PEER_URLS} --advertise-client-urls=${ETCD_ADVERTISE_CLIENT_URLS} --initial-advertise-peer-urls=${ETCD_INITIAL_ADVERTISE_PEER_URLS} --initial-cluster=${ETCD_INITIAL_CLUSTER} --initial-cluster-token=${ETCD_INITIAL_CLUSTER_TOKEN} --initial-cluster-state=new --cert-file=/opt/etcd/ssl/server.pem --key-file=/opt/etcd/ssl/server-ky.pem --peer-cert-file=/opt/etcd/ssl/server.pem --peer-key-file=/opt/etcd/ssl/server-key.pem --trusted-ca-file=/opt/etcd/ssl/ca.pem --peer-truster-ca-file=/opt/etcd/ssl/ca.pem
  Restart=on-failure
  LimitNOFILE=65536
  
  [Install]
  WantedBy=multi-user.target
  ```

  

+ 生成etcd.conf文件

  ```
  ## 配置文件每个节点只要修改name和ip地址即可
  #[Member]
  ETCD_NAME=node1
  ETCD_DATA_DIR=/var/lib/etcd/data
  ETCD_LISTEN_PEER_URLS=http://0.0.0.0:2380
  ETCD_LISTEN_CLIENT_URLS=http://0.0.0.0:2379
  
  #[cluster]
  ETCD_INITIAL_ADVERTISE_PEER_URLS=http://192.168.19.136:2380
  ETCD_ADVERTISE_CLIENT_URLS=http://192.168.19.136:2379
  ETCD_INITIAL_CLUSTER=node1=http://192.168.19.136:2380,node2=http://192.168.19.137:2380,node3=http://192.168.19.138:2380
  ETCD_INITIAL_CLUSTER_STATE=new
  #创建集群的 token，这个值每个集群保持唯一
  ETCD_INITIAL_CLUSTER_TOKEN=etcd-1
  
  ```

+ 启动并设置开机启动

  ```
  systemctl daemon-reload
  systemctl start etcd
  systemctl enable etcd
  ```

  

## 4、部署master组件

```
1.kube-apiserver
2.kube-controller-manager
3.kube-schduler
4.etcd
```

## 5、部署node组件

```
1.kubelet
2.kube-proxy
3.docker
4.etcd
```

## 6、部署集群网络

​	